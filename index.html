<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<meta http-equiv="X-Content-Type-Options" content="nosniff"/>
<meta http-equiv="X-Frame-Options" content="DENY"/>
<meta name="description" content="For Hanna — A romantic voice guestbook"/>
<title>For Hanna ✦ Voice Guestbook</title>

<!-- Firebase v9 compat (CDN) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300;1,400;1,600&family=Cormorant:ital,wght@0,300;1,300&family=Cinzel:wght@400;600&display=swap" rel="stylesheet"/>

<style>
/* ══════════════════════════════════════
   RESET & ROOT
══════════════════════════════════════ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --gold:#B8943C;
  --gold-l:#D4AF60;
  --gold-ll:#E8CF90;
  --gold-d:#7A5F20;
  --gold-dd:#3D2F10;
  --rose:#8B3A52;
  --rose-l:#B05070;
  --black:#060404;
  --deep:#0D0809;
  --dark:#120D0E;
  --ink:#1C1518;
  --cream:#F5EFE0;
  --cream-d:rgba(245,239,224,0.65);
  --cream-m:rgba(245,239,224,0.30);
  --cream-s:rgba(245,239,224,0.12);
  --red-r:#7A0020;
  --red-rb:#AA0030;
  --green-s:rgba(80,200,100,0.15);
  --green-c:#44CC66;
}

html,body{
  width:100%;height:100%;
  background:var(--black);
  color:var(--cream);
  font-family:'Cormorant Garamond',serif;
  -webkit-font-smoothing:antialiased;
  overflow:hidden;
  user-select:none;
  -webkit-user-select:none;
  -webkit-tap-highlight-color:transparent;
}

/* ══════════════════════════════════════
   BACKGROUND — PAPER TEXTURE + VIGNETTE
══════════════════════════════════════ */
body::before{
  content:'';
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background:
    radial-gradient(ellipse 120% 80% at 50% 50%,rgba(30,10,15,0) 40%,rgba(6,4,4,0.95) 100%),
    url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='400' height='400'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.72' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='400' height='400' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
}
body::after{
  content:'';
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 90% 90% at 50% 50%, rgba(70,20,30,0.06) 0%, transparent 70%);
}

/* ══════════════════════════════════════
   PAGES
══════════════════════════════════════ */
.page{
  position:fixed;inset:0;z-index:1;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  padding:clamp(1rem,5vw,3rem) clamp(1rem,5vw,2.5rem);
  gap:clamp(0.5rem,1.8vh,1.4rem);
  opacity:0;pointer-events:none;
  transition:opacity 0.8s ease;
  overflow-y:auto;
  overflow-x:hidden;
}
.page.active{opacity:1;pointer-events:all;}

/* ══════════════════════════════════════
   ORNAMENTAL DIVIDERS
══════════════════════════════════════ */
.orn{
  display:flex;align-items:center;gap:.7rem;
  color:var(--gold);
  flex-shrink:0;
}
.orn::before,.orn::after{
  content:'';
  height:1px;width:clamp(24px,8vw,60px);
  background:linear-gradient(to right,transparent,var(--gold-d),var(--gold),var(--gold-d),transparent);
}
.orn span{font-size:clamp(.55rem,1.2vw,.75rem);letter-spacing:.5em;}

/* ══════════════════════════════════════
   PAGE 1 — LANDING
══════════════════════════════════════ */
#p1{
  background:
    radial-gradient(ellipse 70% 55% at 50% 55%, #1a0c10 0%, transparent 80%),
    radial-gradient(ellipse 40% 30% at 50% 30%, #0f080a 0%, transparent 70%);
  justify-content:space-between;
  padding-top:clamp(1.2rem,5vh,3rem);
  padding-bottom:clamp(1.2rem,4vh,2rem);
}

/* Header */
.lnd-eyebrow{
  font-family:'Cinzel',serif;
  font-size:clamp(.5rem,1.3vw,.72rem);
  letter-spacing:.5em;text-transform:uppercase;
  color:var(--gold-d);
  opacity:0;transform:translateY(-8px);
  transition:opacity 1s .5s ease,transform 1s .5s ease;
}
.lnd-eyebrow.v{opacity:1;transform:none;}

.lnd-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-style:italic;
  font-size:clamp(2.4rem,9vw,5.5rem);
  color:var(--gold-ll);
  letter-spacing:.04em;line-height:.95;text-align:center;
  opacity:0;transform:translateY(14px);
  transition:opacity 1.1s .7s ease,transform 1.1s .7s ease;
  text-shadow:0 0 60px rgba(184,148,60,.18);
}
.lnd-title.v{opacity:1;transform:none;}

.lnd-date{
  font-family:'Cormorant',serif;
  font-weight:300;font-style:italic;
  font-size:clamp(.75rem,2vw,1.1rem);
  color:var(--cream-d);letter-spacing:.22em;
  opacity:0;transition:opacity 1s 1s ease;
}
.lnd-date.v{opacity:1;}

/* Phone SVG */
.phone-stage{
  position:relative;
  width:clamp(190px,50vw,320px);
  flex-shrink:0;
}
.phone-stage svg{width:100%;height:auto;overflow:visible;}

#g-base{
  opacity:0;transform-origin:50% 80%;
  transform:translateY(28px) scale(.94);
  transition:opacity 1.2s .5s ease,transform 1.2s .5s cubic-bezier(.22,1,.36,1);
}
#g-base.v{opacity:1;transform:none;}

#g-handset{
  opacity:0;transform-origin:50% 50%;
  transform:translateY(-20px);
  transition:opacity 1s 1.7s ease,transform 1s 1.7s cubic-bezier(.34,1.56,.64,1);
}
#g-handset.v{opacity:1;transform:none;}

#g-dial{
  opacity:0;transform-origin:50% 50%;
  transform:scale(.2) rotate(-270deg);
  transition:opacity .9s 2.9s ease,transform .9s 2.9s cubic-bezier(.34,1.4,.64,1);
}
#g-dial.v{opacity:1;transform:none;}

#g-cord{
  opacity:0;
  transition:opacity .8s 3.8s ease;
}
#g-cord.v{opacity:1;}

/* CTA Button */
.cta-btn{
  font-family:'Cinzel',serif;
  font-size:clamp(.6rem,1.6vw,.85rem);
  letter-spacing:.45em;text-transform:uppercase;
  color:var(--gold);
  padding:.75em 2.5em;
  border:1px solid var(--gold-d);
  background:transparent;
  cursor:pointer;
  position:relative;overflow:hidden;
  opacity:0;transform:translateY(8px);
  transition:opacity .9s 4.5s ease,transform .9s 4.5s ease,color .35s,border-color .35s;
  flex-shrink:0;
}
.cta-btn.v{opacity:1;transform:none;}
.cta-btn::before{
  content:'';position:absolute;inset:0;
  background:linear-gradient(to right,var(--gold-dd),var(--gold-d));
  transform:scaleX(0);transform-origin:left;
  transition:transform .4s cubic-bezier(.22,1,.36,1);
  z-index:-1;
}
.cta-btn:hover::before{transform:scaleX(1);}
.cta-btn:hover{color:var(--cream);border-color:var(--gold);}
.cta-btn:active{transform:scale(.97);}

/* floating petals */
.petal{
  position:fixed;pointer-events:none;z-index:0;
  font-size:clamp(.6rem,1.5vw,.9rem);
  opacity:0;
  animation:fall linear infinite;
}
@keyframes fall{
  0%{opacity:0;transform:translateY(-20px) rotate(0deg);}
  5%{opacity:.35;}
  90%{opacity:.2;}
  100%{opacity:0;transform:translateY(110vh) rotate(360deg);}
}

/* ══════════════════════════════════════
   PAGE 2 — ROTARY PASSWORD
══════════════════════════════════════ */
#p2{
  background:radial-gradient(ellipse 70% 65% at 50% 45%, #12080C 0%, var(--black) 100%);
  gap:clamp(.5rem,1.5vh,1.2rem);
}

.pg-title{
  font-family:'Cormorant Garamond',serif;
  font-weight:300;font-style:italic;
  font-size:clamp(1.4rem,5vw,2.6rem);
  color:var(--gold-ll);
  letter-spacing:.05em;text-align:center;
  line-height:1.1;
}
.pg-sub{
  font-family:'Cinzel',serif;
  font-size:clamp(.48rem,1.2vw,.68rem);
  letter-spacing:.4em;text-transform:uppercase;
  color:var(--cream-m);text-align:center;
}

/* PIN display */
.pin-row{
  display:flex;gap:clamp(.7rem,2.5vw,1.3rem);
  align-items:center;
}
.pin-gem{
  width:clamp(11px,3vw,18px);height:clamp(11px,3vw,18px);
  border-radius:50%;
  border:1.5px solid var(--gold-d);
  background:transparent;
  transition:background .4s,box-shadow .4s,transform .3s;
}
.pin-gem.lit{
  background:radial-gradient(circle at 35% 30%,var(--gold-ll),var(--gold));
  box-shadow:0 0 12px rgba(184,148,60,.7),0 0 3px rgba(184,148,60,.4);
  transform:scale(1.15);
}

/* Rotary wrapper */
.rotary-wrap{
  position:relative;
  width:clamp(220px,62vw,300px);
  height:clamp(220px,62vw,300px);
  flex-shrink:0;
}

#rotary-disk{
  width:100%;height:100%;
  border-radius:50%;
  background:
    radial-gradient(circle at 38% 32%, #2a1a0a 0%, #120c05 55%, #080602 100%);
  border:2.5px solid var(--gold-d);
  box-shadow:
    0 8px 48px rgba(0,0,0,.8),
    inset 0 2px 12px rgba(0,0,0,.7),
    0 0 0 1px rgba(184,148,60,.15);
  position:relative;
  transform-origin:50% 50%;
  will-change:transform;
}
#rotary-disk::before{
  content:'';position:absolute;inset:10%;
  border-radius:50%;
  border:1px solid rgba(184,148,60,.12);
  pointer-events:none;
}

/* Medallion */
.r-medallion{
  position:absolute;top:50%;left:50%;
  width:28%;height:28%;
  transform:translate(-50%,-50%);
  border-radius:50%;
  background:
    radial-gradient(circle at 38% 30%,#C9A84C,#8B6A20 50%,#3D2F10 100%);
  border:1.5px solid var(--gold-d);
  box-shadow:inset 0 2px 8px rgba(0,0,0,.6);
  display:flex;align-items:center;justify-content:center;
  flex-direction:column;pointer-events:none;z-index:5;
}
.r-medallion p{
  font-family:'Cormorant',serif;font-style:italic;
  font-size:clamp(4px,1.2vw,7px);
  color:rgba(245,239,224,.55);
  letter-spacing:.08em;line-height:1.4;text-align:center;
}

/* Finger hole */
.d-hole{
  position:absolute;
  width:clamp(22px,7vw,34px);height:clamp(22px,7vw,34px);
  border-radius:50%;
  background:radial-gradient(circle at 40% 35%,#181818,#050505);
  border:1.5px solid var(--gold-d);
  display:flex;align-items:center;justify-content:center;
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(9px,2.5vw,15px);font-weight:600;
  color:var(--gold-ll);
  cursor:pointer;
  transform:translate(-50%,-50%);
  box-shadow:inset 0 2px 6px rgba(0,0,0,.95),0 1px 3px rgba(184,148,60,.15);
  transition:box-shadow .2s,background .2s;
  z-index:10;
}
.d-hole:hover{
  box-shadow:inset 0 2px 6px rgba(0,0,0,.95),0 0 12px rgba(184,148,60,.4);
}
.d-hole:active{filter:brightness(.8);}

/* Stop guard */
.dial-stop{
  position:absolute;right:-8px;top:50%;
  transform:translateY(-50%);
  width:clamp(10px,3vw,16px);height:clamp(24px,7vw,38px);
  background:linear-gradient(to bottom,var(--gold-ll),var(--gold),var(--gold-d));
  border-radius:8px;
  box-shadow:2px 0 12px rgba(0,0,0,.5);
  z-index:20;pointer-events:none;
}

/* Dial feedback */
.dial-feedback{
  font-family:'Cormorant Garamond',serif;
  font-style:italic;
  font-size:clamp(.85rem,2.2vw,1.2rem);
  color:var(--gold);letter-spacing:.12em;
  text-align:center;min-height:1.5em;
  transition:color .4s,opacity .3s;
}

/* ══════════════════════════════════════
   PAGE 3 — VOICE MESSAGES
══════════════════════════════════════ */
#p3{
  background:
    radial-gradient(ellipse 80% 60% at 50% 30%, #0C1012 0%, var(--black) 100%);
  justify-content:flex-start;
  padding-top:clamp(1.5rem,5vh,3rem);
  gap:clamp(.5rem,1.5vh,1.1rem);
}

/* Recording controls (admin only) */
#admin-zone{
  display:none;flex-direction:column;align-items:center;gap:.8rem;
  width:min(500px,92vw);
}
#admin-zone.show{display:flex;}

.rec-ring{
  position:relative;display:flex;align-items:center;justify-content:center;
}
.rec-ring::before{
  content:'';position:absolute;
  width:calc(100% + 14px);height:calc(100% + 14px);
  border-radius:50%;
  border:1px solid rgba(184,148,60,.25);
  animation:ring-pulse 3s ease-in-out infinite;
}
@keyframes ring-pulse{
  0%,100%{transform:scale(1);opacity:.3;}
  50%{transform:scale(1.08);opacity:.7;}
}

.mic-btn{
  width:clamp(58px,13vw,76px);
  height:clamp(58px,13vw,76px);
  border-radius:50%;
  background:radial-gradient(circle at 38% 32%,#9A0028,#5A0018 55%,#2A000C 100%);
  border:2px solid rgba(184,148,60,.4);
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 24px rgba(120,0,32,.4),0 0 0 1px rgba(184,148,60,.1);
  transition:all .35s cubic-bezier(.34,1.56,.64,1);
  position:relative;z-index:1;
}
.mic-btn:hover{
  transform:scale(1.07);
  box-shadow:0 6px 36px rgba(170,0,48,.5),0 0 0 1px rgba(184,148,60,.25);
}
.mic-btn.rec-active{
  background:radial-gradient(circle at 38% 32%,#DD0030,#8A001C 55%,#3A000E 100%);
  animation:mic-pulse 1.2s ease-in-out infinite;
}
@keyframes mic-pulse{
  0%,100%{box-shadow:0 4px 24px rgba(200,0,40,.5);}
  50%{box-shadow:0 6px 48px rgba(255,0,60,.75),0 0 20px rgba(255,0,60,.3);}
}
.mic-btn svg{width:clamp(20px,5vw,28px);height:clamp(20px,5vw,28px);}

.rec-label{
  font-family:'Cinzel',serif;
  font-size:clamp(.48rem,1.2vw,.68rem);
  letter-spacing:.38em;text-transform:uppercase;
  color:var(--cream-m);text-align:center;min-height:1.4em;
}
.rec-clock{
  font-family:'Cormorant Garamond',serif;font-style:italic;
  font-size:clamp(1.1rem,3vw,1.7rem);
  color:var(--rose-l);letter-spacing:.08em;
  display:none;
}
.rec-clock.show{display:block;}

/* Canvas waveform */
#waveCanvas{
  display:none;
  width:min(380px,85vw);height:44px;
  border-radius:2px;
  border:1px solid rgba(184,148,60,.08);
}
#waveCanvas.show{display:block;}

/* Upload progress */
.upload-bar-wrap{
  width:min(380px,85vw);height:3px;
  background:rgba(245,239,224,.06);
  border-radius:2px;
  display:none;overflow:hidden;
}
.upload-bar-wrap.show{display:block;}
.upload-bar{
  height:100%;width:0%;
  background:linear-gradient(to right,var(--gold-d),var(--gold));
  border-radius:2px;
  transition:width .25s ease;
}

/* Messages list */
.messages-wrap{
  width:min(500px,92vw);
  display:flex;flex-direction:column;gap:.4rem;
}
.messages-head{
  font-family:'Cinzel',serif;
  font-size:clamp(.46rem,1.1vw,.65rem);
  letter-spacing:.45em;text-transform:uppercase;
  color:var(--gold-d);text-align:center;
  margin-bottom:.25rem;
}
.msg-scroll{
  max-height:clamp(130px,36vh,270px);
  overflow-y:auto;
  display:flex;flex-direction:column;gap:.45rem;
  padding-right:3px;
}
.msg-scroll::-webkit-scrollbar{width:3px;}
.msg-scroll::-webkit-scrollbar-track{background:transparent;}
.msg-scroll::-webkit-scrollbar-thumb{background:var(--gold-dd);border-radius:2px;}

/* Message card */
.msg-card{
  display:flex;align-items:center;gap:.75rem;
  padding:.65rem .9rem;
  border:1px solid rgba(184,148,60,.14);
  border-radius:1px;
  background:rgba(184,148,60,.03);
  transition:background .25s,border-color .25s;
}
.msg-card:hover{background:rgba(184,148,60,.07);border-color:rgba(184,148,60,.28);}

.play-ring{
  flex-shrink:0;
  width:clamp(30px,7vw,38px);height:clamp(30px,7vw,38px);
  border-radius:50%;
  background:linear-gradient(135deg,var(--gold-ll),var(--gold));
  border:none;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 2px 10px rgba(184,148,60,.25);
  transition:all .25s;
}
.play-ring:hover{transform:scale(1.12);box-shadow:0 4px 18px rgba(184,148,60,.4);}
.play-ring.playing{background:linear-gradient(135deg,#e07080,#a03048);}
.play-ring svg{width:11px;height:11px;}

.msg-info{flex:1;min-width:0;}
.msg-title{
  font-family:'Cormorant Garamond',serif;
  font-size:clamp(.75rem,1.8vw,1rem);
  color:var(--cream);opacity:.88;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
}
.msg-meta{
  font-size:clamp(.52rem,1.2vw,.72rem);
  color:var(--cream-m);margin-top:.1rem;
}

/* Audio progress bar in card */
.msg-prog{
  height:2px;margin-top:.35rem;
  background:rgba(184,148,60,.15);border-radius:1px;overflow:hidden;
  display:none;
}
.msg-prog.show{display:block;}
.msg-prog-fill{height:100%;width:0%;background:var(--gold);border-radius:1px;transition:width .2s linear;}

.del-btn{
  flex-shrink:0;background:transparent;
  border:1px solid rgba(180,50,60,.2);
  color:rgba(200,70,80,.45);
  width:clamp(20px,4.5vw,26px);height:clamp(20px,4.5vw,26px);
  border-radius:50%;cursor:pointer;
  font-size:.7rem;
  display:flex;align-items:center;justify-content:center;
  transition:all .2s;
}
.del-btn:hover{background:rgba(180,50,60,.12);border-color:rgba(200,80,90,.6);color:rgba(220,90,100,1);}

.no-msg{
  text-align:center;
  color:rgba(245,239,224,.15);
  font-style:italic;
  padding:1.5rem .5rem;
  font-size:clamp(.8rem,2vw,1.05rem);
  letter-spacing:.05em;
}

/* Firebase status */
#fb-status{
  font-size:clamp(.5rem,1.2vw,.68rem);
  letter-spacing:.25em;text-transform:uppercase;
  text-align:center;
  min-height:1.2em;
  transition:color .4s;
}
.fb-ok{color:var(--green-c);}
.fb-err{color:#cc4444;}
.fb-load{color:var(--gold-d);}

/* Back + shared buttons */
.ghost-btn{
  font-family:'Cinzel',serif;
  font-size:clamp(.46rem,1.2vw,.68rem);
  letter-spacing:.38em;text-transform:uppercase;
  padding:.55em 1.8em;
  border:1px solid rgba(184,148,60,.18);
  background:transparent;
  color:rgba(184,148,60,.38);
  cursor:pointer;
  transition:all .3s;
  flex-shrink:0;
}
.ghost-btn:hover{border-color:rgba(184,148,60,.55);color:rgba(184,148,60,.8);}

/* ══════════════════════════════════════
   TOAST
══════════════════════════════════════ */
#toast{
  position:fixed;bottom:1.4rem;left:50%;
  transform:translateX(-50%);
  padding:.5rem 1.5rem;
  border-radius:1px;border:1px solid;
  font-family:'Cinzel',serif;
  font-size:clamp(.5rem,1.3vw,.72rem);
  letter-spacing:.18em;text-transform:uppercase;
  white-space:nowrap;z-index:1000;
  opacity:0;pointer-events:none;
  transition:opacity .4s;
}
#toast.ok{border-color:rgba(68,200,100,.4);color:var(--green-c);background:rgba(10,40,20,.5);}
#toast.err{border-color:rgba(200,60,60,.4);color:#DD5566;background:rgba(40,8,12,.5);}
#toast.show{opacity:1;}

/* Loading spinner */
#loader{
  position:fixed;inset:0;z-index:500;
  background:var(--black);
  display:flex;align-items:center;justify-content:center;
  transition:opacity .8s;
}
#loader.hide{opacity:0;pointer-events:none;}
.spin-ring{
  width:40px;height:40px;border-radius:50%;
  border:1.5px solid rgba(184,148,60,.15);
  border-top-color:var(--gold);
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* Admin hint */
#adm-hint{
  position:fixed;bottom:.6rem;right:.75rem;
  color:rgba(184,148,60,.08);font-size:.55rem;
  cursor:pointer;z-index:100;
  transition:color .4s;
  letter-spacing:.05em;
}
#adm-hint:hover{color:rgba(184,148,60,.2);}

/* Responsive overflow tweak */
@media(max-height:580px){
  .phone-stage{width:clamp(140px,38vw,210px);}
  .lnd-title{font-size:clamp(1.8rem,7vw,3.2rem);}
  .rotary-wrap{width:clamp(180px,52vw,250px);height:clamp(180px,52vw,250px);}
}
</style>
</head>
<body>

<!-- Loading screen -->
<div id="loader"><div class="spin-ring"></div></div>

<!-- ════════════════════════════════════
     PAGE 1 — LANDING
════════════════════════════════════ -->
<div id="p1" class="page active">

  <!-- Petals injected by JS -->

  <div style="display:flex;flex-direction:column;align-items:center;gap:.35rem;flex-shrink:0;">
    <div class="lnd-eyebrow" id="eye">A Voice Message for</div>
    <div class="lnd-title" id="lndT">Hanna</div>
    <div class="lnd-date" id="lndD">Leave her your voice, forever</div>
  </div>

  <div class="orn" id="orn1"><span>✦</span></div>

  <!-- Phone SVG -->
  <div class="phone-stage">
    <svg viewBox="0 0 360 430" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <radialGradient id="bGr" cx="40%" cy="30%" r="65%">
          <stop offset="0%" stop-color="#252020"/>
          <stop offset="100%" stop-color="#080606"/>
        </radialGradient>
        <radialGradient id="gGr" cx="38%" cy="32%" r="62%">
          <stop offset="0%" stop-color="#D4AF60"/>
          <stop offset="60%" stop-color="#B8943C"/>
          <stop offset="100%" stop-color="#4A3010"/>
        </radialGradient>
        <radialGradient id="dGr" cx="40%" cy="30%" r="60%">
          <stop offset="0%" stop-color="#2a180a"/>
          <stop offset="50%" stop-color="#160e04"/>
          <stop offset="100%" stop-color="#080602"/>
        </radialGradient>
        <radialGradient id="hGr" cx="40%" cy="35%" r="65%">
          <stop offset="0%" stop-color="#181818"/>
          <stop offset="100%" stop-color="#030303"/>
        </radialGradient>
        <filter id="dropshadow">
          <feDropShadow dx="2" dy="6" stdDeviation="9" flood-color="#000" flood-opacity=".72"/>
        </filter>
      </defs>

      <!-- CORD -->
      <g id="g-cord">
        <path d="M282 168 Q295 128 290 96 Q285 68 298 46 Q308 30 296 18 Q284 6 288 -8"
              stroke="#1e1818" stroke-width="4.5" fill="none" stroke-linecap="round" opacity=".8"/>
        <path d="M283 166 Q298 158 295 145 Q292 132 278 134 Q264 136 267 150 Q270 162 283 164"
              stroke="#2a2020" stroke-width="3" fill="none"/>
        <path d="M285 145 Q300 137 297 124 Q294 111 280 113 Q266 115 269 128"
              stroke="#2a2020" stroke-width="3" fill="none"/>
        <path d="M287 125 Q302 117 299 104 Q296 91 282 93 Q268 95 271 108"
              stroke="#2a2020" stroke-width="3" fill="none"/>
      </g>

      <!-- BASE + BODY -->
      <g id="g-base" filter="url(#dropshadow)">
        <rect x="45" y="298" width="270" height="108" rx="14" fill="url(#bGr)" stroke="#7A5F20" stroke-width="1.5"/>
        <rect x="55" y="302" width="250" height="5" rx="2.5" fill="#181414"/>
        <rect x="55" y="401" width="250" height="3" rx="1.5" fill="#181414"/>
        <line x1="58" y1="315" x2="302" y2="315" stroke="#B8943C" stroke-width=".5" opacity=".3"/>
        <line x1="58" y1="402" x2="302" y2="402" stroke="#B8943C" stroke-width=".5" opacity=".3"/>
        <circle cx="62" cy="403" r="4" fill="#181414" stroke="#7A5F20" stroke-width=".6" opacity=".5"/>
        <circle cx="298" cy="403" r="4" fill="#181414" stroke="#7A5F20" stroke-width=".6" opacity=".5"/>
        <path d="M80 168 L88 300 L272 300 L280 168 Z" fill="url(#bGr)" stroke="#7A5F20" stroke-width="1.5" stroke-linejoin="round"/>
        <path d="M80 168 Q180 152 280 168 L278 183 Q180 167 82 183 Z" fill="#111010" stroke="#7A5F20" stroke-width=".8"/>
        <rect x="272" y="248" width="17" height="9" rx="2.5" fill="#080606" stroke="#7A5F20" stroke-width=".7" opacity=".6"/>
        <path d="M90 194 L94 292" stroke="#B8943C" stroke-width=".4" opacity=".2"/>
        <path d="M266 194 L262 292" stroke="#B8943C" stroke-width=".4" opacity=".2"/>
      </g>

      <!-- HANDSET -->
      <g id="g-handset" filter="url(#dropshadow)">
        <ellipse cx="108" cy="166" rx="21" ry="12" fill="#131010" stroke="#B8943C" stroke-width="1.2"/>
        <ellipse cx="252" cy="166" rx="21" ry="12" fill="#131010" stroke="#B8943C" stroke-width="1.2"/>
        <path d="M87 152 Q180 105 273 152" stroke="#0e0c0c" stroke-width="36" fill="none" stroke-linecap="round"/>
        <path d="M87 152 Q180 105 273 152" stroke="#181414" stroke-width="31" fill="none" stroke-linecap="round"/>
        <path d="M87 145 Q180 98 273 145" stroke="#B8943C" stroke-width=".8" fill="none" opacity=".28"/>
        <!-- Left earpiece -->
        <ellipse cx="87" cy="152" rx="21" ry="21" fill="#121010" stroke="#B8943C" stroke-width="1.5"/>
        <ellipse cx="87" cy="152" rx="13" ry="13" fill="#090707" stroke="#7A5F20" stroke-width=".7" opacity=".55"/>
        <circle cx="83" cy="147" r="1.8" fill="#2a2020"/><circle cx="87" cy="145" r="1.8" fill="#2a2020"/>
        <circle cx="91" cy="147" r="1.8" fill="#2a2020"/><circle cx="81" cy="153" r="1.8" fill="#2a2020"/>
        <circle cx="87" cy="153" r="1.8" fill="#2a2020"/><circle cx="93" cy="153" r="1.8" fill="#2a2020"/>
        <circle cx="83" cy="159" r="1.8" fill="#2a2020"/><circle cx="87" cy="160" r="1.8" fill="#2a2020"/>
        <circle cx="91" cy="159" r="1.8" fill="#2a2020"/>
        <!-- Right mouthpiece -->
        <ellipse cx="273" cy="152" rx="21" ry="21" fill="#121010" stroke="#B8943C" stroke-width="1.5"/>
        <ellipse cx="273" cy="152" rx="13" ry="13" fill="#090707" stroke="#7A5F20" stroke-width=".7" opacity=".55"/>
        <circle cx="269" cy="147" r="1.8" fill="#2a2020"/><circle cx="273" cy="145" r="1.8" fill="#2a2020"/>
        <circle cx="277" cy="147" r="1.8" fill="#2a2020"/><circle cx="267" cy="153" r="1.8" fill="#2a2020"/>
        <circle cx="273" cy="153" r="1.8" fill="#2a2020"/><circle cx="279" cy="153" r="1.8" fill="#2a2020"/>
        <circle cx="269" cy="159" r="1.8" fill="#2a2020"/><circle cx="273" cy="160" r="1.8" fill="#2a2020"/>
        <circle cx="277" cy="159" r="1.8" fill="#2a2020"/>
        <path d="M66 152 A21 21 0 0 1 108 152" stroke="#B8943C" stroke-width="1" fill="none" opacity=".35"/>
        <path d="M252 152 A21 21 0 0 1 294 152" stroke="#B8943C" stroke-width="1" fill="none" opacity=".35"/>
      </g>

      <!-- DIAL (decorative on landing) -->
      <g id="g-dial">
        <circle cx="180" cy="238" r="72" fill="url(#bGr)" stroke="#7A5F20" stroke-width="1.8"/>
        <circle cx="180" cy="238" r="65" fill="url(#dGr)" stroke="#B8943C" stroke-width=".5" opacity=".3"/>
        <circle cx="180" cy="238" r="22" fill="url(#gGr)" stroke="#B8943C" stroke-width="1.3"/>
        <circle cx="180" cy="238" r="16" fill="none" stroke="rgba(245,239,224,.1)" stroke-width=".8"/>
        <text x="180" y="234" text-anchor="middle" fill="rgba(245,239,224,.5)" font-size="4.5" font-style="italic" font-family="Cormorant Garamond,serif">Antique</text>
        <text x="180" y="242" text-anchor="middle" fill="rgba(245,239,224,.38)" font-size="4" font-family="Cormorant Garamond,serif">Collection</text>
        <!-- Static holes -->
        <g id="svgH"></g>
        <!-- Stop guard -->
        <rect x="241" y="230" width="12" height="14" rx="3" fill="url(#gGr)" stroke="#4A3010" stroke-width=".7"/>
      </g>
    </svg>
  </div>

  <button class="cta-btn" id="ctaBtn" onclick="goTo('p2')">Enter</button>
  <div class="orn" id="orn2"><span>✦</span></div>

</div><!-- /p1 -->

<!-- ════════════════════════════════════
     PAGE 2 — ROTARY PASSWORD
════════════════════════════════════ -->
<div id="p2" class="page">
  <div class="pg-title">Dial the Secret Code</div>
  <div class="orn"><span>✦</span></div>
  <div class="pg-sub">Spin the dial to unlock</div>

  <div class="pin-row">
    <div class="pin-gem" id="pg0"></div>
    <div class="pin-gem" id="pg1"></div>
    <div class="pin-gem" id="pg2"></div>
    <div class="pin-gem" id="pg3"></div>
  </div>

  <div class="rotary-wrap">
    <div id="rotary-disk">
      <div class="r-medallion">
        <p>Antique</p>
        <p style="font-size:clamp(3px,.8vw,5px);opacity:.4;">⬡</p>
        <p>Collection</p>
      </div>
      <!-- holes injected by JS -->
    </div>
    <div class="dial-stop"></div>
  </div>

  <div class="dial-feedback" id="dialFb">Spin a number to begin</div>
  <button class="ghost-btn" onclick="goTo('p1')">← Return</button>
</div>

<!-- ════════════════════════════════════
     PAGE 3 — VOICE
════════════════════════════════════ -->
<div id="p3" class="page">
  <div class="pg-title" id="v3title">Listen to Her Messages</div>
  <div class="orn"><span>✦</span></div>

  <!-- Admin record zone -->
  <div id="admin-zone">
    <div class="rec-label" id="recLabel">Press to record a message for Hanna</div>
    <div class="rec-ring">
      <button class="mic-btn" id="micBtn" onclick="toggleRec()" aria-label="Record voice message">
        <svg viewBox="0 0 28 28" fill="none"><rect x="10" y="3" width="8" height="14" rx="4" fill="#F5EFE0" opacity=".9"/><path d="M6 14c0 4.4 3.6 8 8 8s8-3.6 8-8" stroke="#F5EFE0" stroke-width="2" stroke-linecap="round" fill="none" opacity=".9"/><line x1="14" y1="22" x2="14" y2="26" stroke="#F5EFE0" stroke-width="2" stroke-linecap="round" opacity=".9"/></svg>
      </button>
    </div>
    <div class="rec-clock" id="recClock">0:00</div>
    <canvas id="waveCanvas" width="380" height="44"></canvas>
    <div class="upload-bar-wrap" id="uploadWrap"><div class="upload-bar" id="uploadBar"></div></div>
  </div>

  <!-- Message list -->
  <div class="messages-wrap">
    <div class="messages-head">Voice Messages</div>
    <div class="msg-scroll" id="msgList">
      <div class="no-msg">No messages yet — be the first to leave one ✦</div>
    </div>
  </div>

  <div id="fb-status" class="fb-load">Connecting…</div>

  <button class="ghost-btn" onclick="goTo('p1')">← Return</button>
</div>

<!-- Toast -->
<div id="toast"></div>
<!-- Admin hint -->
<div id="adm-hint" title="Admin">⬡</div>

<!-- ════════════════════════════════════
     FIREBASE CONFIG — REPLACE THIS!
════════════════════════════════════ -->
<script>
// ┌─────────────────────────────────────────────────────────┐
// │  STEP 1 — Replace these values with YOUR Firebase config │
// │  (see SETUP GUIDE at bottom of file for instructions)    │
// └─────────────────────────────────────────────────────────┘
const FIREBASE_CONFIG = {
  apiKey:            "REPLACE_WITH_YOUR_API_KEY",
  authDomain:        "REPLACE_WITH_YOUR_AUTH_DOMAIN",
  projectId:         "REPLACE_WITH_YOUR_PROJECT_ID",
  storageBucket:     "REPLACE_WITH_YOUR_STORAGE_BUCKET",
  messagingSenderId: "REPLACE_WITH_YOUR_MESSAGING_SENDER_ID",
  appId:             "REPLACE_WITH_YOUR_APP_ID"
};
</script>

<!-- ════════════════════════════════════
     MAIN SCRIPT
════════════════════════════════════ -->
<script>
/* ──────────────────────────────────────
   CONSTANTS
────────────────────────────────────── */
const CFG = Object.freeze({
  PASS:        '8825',
  ADMIN_CODE:  'hanna2025',
  MAX_REC_SEC: 120,
  MAX_RECS:    30,
  LOCKOUT_MS:  30_000,
  MAX_FAILS:   5,
  COLLECTION:  'voiceMessages',
});

/* ──────────────────────────────────────
   SECURITY: sanitize
────────────────────────────────────── */
const san = s => String(s).replace(/[<>&"'`\/]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;',"'":'&#39;','`':'&#96;','/':'&#47;'}[c]));

/* ──────────────────────────────────────
   RATE LIMITER
────────────────────────────────────── */
const RL = {
  fails:0, until:0,
  ok(){ return Date.now() > this.until; },
  lockMsg(){ return `Locked — wait ${Math.ceil((this.until-Date.now())/1000)}s`; },
  fail(){ this.fails++; if(this.fails>=CFG.MAX_FAILS){this.until=Date.now()+CFG.LOCKOUT_MS;this.fails=0;return true;} return false; },
  reset(){ this.fails=0;this.until=0; }
};

/* ──────────────────────────────────────
   STATE
────────────────────────────────────── */
let curPage = 'p1';
let isAdmin = false;
let pinBuf  = [];
let dialBusy = false;
let isRec = false;
let mediaRec = null;
let recChunks = [];
let recElapsed = 0;
let recTick = null;
let audioCtx = null;
let analyser = null;
let rafId = null;
let fbReady = false;
let db;
let adminClicks = 0, adminTimer = null;

/* ──────────────────────────────────────
   FIREBASE INIT
────────────────────────────────────── */
function initFirebase(){
  try{
    // Check if config has been filled in
    if(FIREBASE_CONFIG.apiKey.startsWith('REPLACE')){
      showFbStatus('Firebase not configured — see setup guide','err');
      return;
    }
    firebase.initializeApp(FIREBASE_CONFIG);
    db      = firebase.firestore();
    fbReady = true;
    showFbStatus('Connected ✦','ok');
    // Test connection with a lightweight call
    db.collection(CFG.COLLECTION).limit(1).get()
      .then(()=>{ showFbStatus('Connected ✦','ok'); loadMessages(); })
      .catch(e=>{ showFbStatus('Connection error — check Firebase rules','err'); console.warn(e); });
  }catch(e){
    showFbStatus('Firebase init failed','err');
    console.warn('Firebase error:',e);
  }
}
function showFbStatus(msg, cls){
  const el = $('fb-status');
  if(!el) return;
  el.textContent = msg;
  el.className = cls==='ok'?'fb-ok':cls==='err'?'fb-err':'fb-load';
  el.style.opacity='1';
  if(cls==='ok') setTimeout(()=>el.style.opacity='0',3000);
}

/* ──────────────────────────────────────
   PAGE NAVIGATION
────────────────────────────────────── */
function goTo(id){
  $('loader').classList.remove('hide'); // brief flash during transition
  setTimeout(()=>{
    $(curPage).classList.remove('active');
    $(id).classList.add('active');
    curPage = id;
    if(id==='p2') buildRotary();
    if(id==='p3') initVoicePage();
    $('loader').classList.add('hide');
  }, 150);
}

/* ──────────────────────────────────────
   PAGE 1 — ASSEMBLY
────────────────────────────────────── */
function startAssembly(){
  buildLandingDial();
  makePetals();

  const seq = [
    [300,  ()=>{ $('g-base').classList.add('v'); }],
    [1600, ()=>{ $('g-handset').classList.add('v'); }],
    [2800, ()=>{ $('g-dial').classList.add('v'); }],
    [3600, ()=>{ $('g-cord').classList.add('v'); }],
    [3700, ()=>{ $('eye').classList.add('v'); $('lndT').classList.add('v'); $('lndD').classList.add('v'); }],
    [4100, ()=>{ $('orn1').style.opacity='1'; }],
    [4500, ()=>{ $('ctaBtn').classList.add('v'); $('orn2').style.opacity='1'; }],
  ];
  seq.forEach(([t,fn])=>setTimeout(fn,t));
}

function buildLandingDial(){
  const g = $('svgH');
  const nums = ['1','2','3','4','5','6','7','8','9','0'];
  const cx=180, cy=238, r=44;
  nums.forEach((n,i)=>{
    const a = (-20 - i*36)*Math.PI/180;
    const x = cx+r*Math.cos(a), y = cy+r*Math.sin(a);
    const c = svgEl('circle');
    attrs(c,{cx:x,cy:y,r:'8.5',fill:'url(#hGr)',stroke:'#7A5F20','stroke-width':'1'});
    const t = svgEl('text');
    attrs(t,{x,y:y+3.5,'text-anchor':'middle',fill:'#D4AF60','font-size':'7','font-family':'Cormorant Garamond,serif','font-weight':'600'});
    t.textContent=n;
    g.appendChild(c); g.appendChild(t);
  });
}

function makePetals(){
  const symbols=['✿','✾','❀','⚘','✤'];
  for(let i=0;i<8;i++){
    const p=document.createElement('div');
    p.className='petal';
    p.textContent=symbols[i%symbols.length];
    p.style.cssText=`
      left:${5+Math.random()*90}%;
      top:-20px;
      color:rgba(${140+Math.floor(Math.random()*40)},${60+Math.floor(Math.random()*30)},${80+Math.floor(Math.random()*30)},0.25);
      animation-duration:${14+Math.random()*14}s;
      animation-delay:${Math.random()*8}s;
      font-size:${0.5+Math.random()*0.7}rem;
    `;
    document.getElementById('p1').appendChild(p);
  }
}

/* ──────────────────────────────────────
   PAGE 2 — ROTARY
────────────────────────────────────── */
function buildRotary(){
  pinBuf=[];
  updatePinDots();
  setFeedback('Spin a number to begin','var(--gold)');

  const disk=$('rotary-disk');
  disk.querySelectorAll('.d-hole').forEach(h=>h.remove());

  const size=disk.offsetWidth||260;
  const r=size*0.372, cx=size/2, cy=size/2;
  const nums=['1','2','3','4','5','6','7','8','9','0'];

  nums.forEach((n,i)=>{
    const a=(-20-i*36)*Math.PI/180;
    const x=cx+r*Math.cos(a), y=cy+r*Math.sin(a);
    const h=document.createElement('div');
    h.className='d-hole';
    h.textContent=n;
    h.style.cssText=`left:${x}px;top:${y}px;`;
    h.dataset.n=n; h.dataset.i=i;
    h.addEventListener('click',()=>onDial(n,i));
    h.addEventListener('touchend',e=>{e.preventDefault();onDial(n,i);},{passive:false});
    disk.appendChild(h);
  });
}

function onDial(num, idx){
  if(!RL.ok()){ setFeedback(RL.lockMsg(),'#ff5555'); return; }
  if(dialBusy || pinBuf.length>=4) return;
  dialBusy=true;

  const disk=$('rotary-disk');
  const rot=(idx+1)*30+15;
  const dur=rot/170;
  const retDur=rot/155;

  disk.querySelectorAll('.d-hole').forEach(h=>h.style.pointerEvents='none');
  // Spin forward (clockwise — finger pushes hole to the right/stop)
  disk.style.transition=`transform ${dur.toFixed(2)}s cubic-bezier(0.15,0,0.35,1)`;
  disk.style.transform=`rotate(${rot}deg)`;

  playTick(idx+1);

  setTimeout(()=>{
    // Spring back counter-clockwise
    disk.style.transition=`transform ${retDur.toFixed(2)}s cubic-bezier(0.35,0,0.1,1)`;
    disk.style.transform='rotate(0deg)';
    setTimeout(()=>{
      pinBuf.push(num);
      updatePinDots();
      setFeedback(`${pinBuf.length} of 4 dialed`,'var(--gold)');
      disk.querySelectorAll('.d-hole').forEach(h=>h.style.pointerEvents='');
      dialBusy=false;
      if(pinBuf.length===4) setTimeout(checkPin,300);
    }, retDur*900);
  }, dur*1000+50);
}

function checkPin(){
  const entered=pinBuf.join('');
  const disk=$('rotary-disk');
  if(entered===CFG.PASS){
    RL.reset();
    setFeedback('✦  Access Granted  ✦','#66EE99');
    disk.style.boxShadow='0 0 50px rgba(80,200,100,.3),0 0 20px rgba(184,148,60,.15)';
    setTimeout(()=>{ disk.style.boxShadow=''; goTo('p3'); },1000);
  } else {
    RL.fail();
    setFeedback('✕  Wrong code, try again','#ee5566');
    disk.style.boxShadow='0 0 35px rgba(220,50,60,.3)';
    shakeEl(disk);
    setTimeout(()=>{
      disk.style.boxShadow='';
      pinBuf=[];updatePinDots();
      setFeedback('Spin a number to begin','var(--gold)');
    },900);
  }
}

function updatePinDots(){
  for(let i=0;i<4;i++) $('pg'+i).classList.toggle('lit',i<pinBuf.length);
}
function setFeedback(msg,col){
  const f=$('dialFb');
  f.textContent=msg; f.style.color=col;
}

function shakeEl(el){
  const steps=[10,-10,8,-8,5,-5,2,-2,0]; let i=0;
  const iv=setInterval(()=>{
    el.style.transform=`translateX(${steps[i]}px)`;
    if(++i>=steps.length){ clearInterval(iv); el.style.transform=''; }
  },70);
}

function playTick(n){
  try{
    const ctx=new(window.AudioContext||window.webkitAudioContext)();
    for(let i=0;i<Math.min(n,10);i++){
      const t=ctx.currentTime+i*0.065;
      const o=ctx.createOscillator(), g=ctx.createGain();
      o.connect(g); g.connect(ctx.destination);
      o.type='triangle'; o.frequency.value=750+i*8;
      g.gain.setValueAtTime(0.07,t);
      g.gain.exponentialRampToValueAtTime(0.001,t+0.055);
      o.start(t); o.stop(t+0.065);
    }
    setTimeout(()=>{ try{ctx.close();}catch(e){} },(n*70)+180);
  }catch(e){}
}

/* ──────────────────────────────────────
   PAGE 3 — VOICE
────────────────────────────────────── */
function initVoicePage(){
  const az=$('admin-zone');
  const vt=$('v3title');
  if(isAdmin){
    az.classList.add('show');
    vt.textContent='Record a Message for Hanna';
  } else {
    az.classList.remove('show');
    vt.textContent='Listen to Her Messages';
  }
  $('p3').removeEventListener('contextmenu',blockCtx);
  $('p3').addEventListener('contextmenu',blockCtx);

  if(fbReady) loadMessages();
  else showFbStatus('Firebase not ready — check config','err');
}
function blockCtx(e){ e.preventDefault(); }

/* LOAD MESSAGES */
function loadMessages(){
  if(!fbReady) return;
  showFbStatus('Loading…','load');
  db.collection(CFG.COLLECTION)
    .orderBy('ts','desc')
    .limit(CFG.MAX_RECS)
    .get()
    .then(snap=>{
      const msgs=[];
      snap.forEach(doc=>msgs.push({id:doc.id,...doc.data()}));
      renderMessages(msgs);
      showFbStatus('Connected ✦','ok');
    })
    .catch(e=>{
      showFbStatus('Could not load messages','err');
      console.warn(e);
    });
}

function renderMessages(msgs){
  const list=$('msgList');
  list.innerHTML='';
  if(!msgs.length){
    list.innerHTML='<div class="no-msg">No messages yet — be the first to leave one ✦</div>';
    return;
  }
  msgs.forEach(msg=>{
    const card=document.createElement('div');
    card.className='msg-card';

    // Play button
    const pb=document.createElement('button');
    pb.className='play-ring';
    pb.setAttribute('aria-label','Play message');
    pb.innerHTML=iconPlay();
    let aud=null;

    const prog=document.createElement('div');
    prog.className='msg-prog';
    const fill=document.createElement('div');
    fill.className='msg-prog-fill';
    prog.appendChild(fill);

    pb.onclick=()=>{
      if(aud&&!aud.paused){
        aud.pause();aud.currentTime=0;
        pb.classList.remove('playing');pb.innerHTML=iconPlay();
        prog.classList.remove('show');
        return;
      }
      // stop others
      list.querySelectorAll('.play-ring.playing').forEach(b=>{
        b.classList.remove('playing');b.innerHTML=iconPlay();
      });
      list.querySelectorAll('.msg-prog').forEach(p=>p.classList.remove('show'));

      try{
        // Support both dataUrl (base64) and url (legacy Storage URL)
        const src = msg.dataUrl || msg.url;
        if(!src){ toast('No audio data found','err'); return; }
        aud=new Audio();
        aud.crossOrigin='anonymous';
        aud.src=src;
        aud.play().then(()=>{
          pb.classList.add('playing');pb.innerHTML=iconPause();
          prog.classList.add('show');
        }).catch(e=>{ console.error(e); toast('Could not play this message','err'); });
        aud.ontimeupdate=()=>{
          if(aud.duration) fill.style.width=((aud.currentTime/aud.duration)*100)+'%';
        };
        aud.onended=()=>{
          pb.classList.remove('playing');pb.innerHTML=iconPlay();
          prog.classList.remove('show');fill.style.width='0%';
        };
      }catch(e){ toast('Audio error','err'); }
    };

    // Info
    const info=document.createElement('div');
    info.className='msg-info';
    const title=document.createElement('div');
    title.className='msg-title';
    title.textContent=san(msg.label||'Voice Message');
    const meta=document.createElement('div');
    meta.className='msg-meta';
    meta.textContent=msg.dateStr||'';
    info.appendChild(title);
    info.appendChild(prog);
    info.appendChild(meta);

    card.appendChild(pb);
    card.appendChild(info);

    // Delete (admin only)
    if(isAdmin){
      const db2=document.createElement('button');
      db2.className='del-btn';
      db2.innerHTML='✕';
      db2.setAttribute('aria-label','Delete message');
      db2.onclick=()=>deleteMessage(msg.id, card);
      card.appendChild(db2);
    }

    list.appendChild(card);
  });
}

/* DELETE */
function deleteMessage(docId, cardEl){
  if(!fbReady) return;
  cardEl.style.opacity='.4';
  db.collection(CFG.COLLECTION).doc(docId).delete()
    .then(()=>{ cardEl.remove(); toast('Message deleted','ok'); })
    .catch(()=>{ cardEl.style.opacity='1'; toast('Delete failed','err'); });
}

/* ──────────────────────────────────────
   RECORDING
────────────────────────────────────── */
async function toggleRec(){
  if(!isAdmin) return;
  isRec ? stopRec() : await startRec();
}

async function startRec(){
  if(!fbReady){ toast('Firebase not ready','err'); return; }
  try{
    const stream=await navigator.mediaDevices.getUserMedia({audio:true,video:false});
    // Analyser for waveform
    audioCtx=new(window.AudioContext||window.webkitAudioContext)();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=128;
    audioCtx.createMediaStreamSource(stream).connect(analyser);

    const mime=bestMime();
    mediaRec=new MediaRecorder(stream,mime?{mimeType:mime}:{});
    recChunks=[];
    mediaRec.ondataavailable=e=>{ if(e.data.size>0) recChunks.push(e.data); };
    mediaRec.onstop=()=>{ stream.getTracks().forEach(t=>t.stop()); uploadRec(); };
    mediaRec.start(100);
    isRec=true; recElapsed=0;

    $('micBtn').classList.add('rec-active');
    $('micBtn').innerHTML=iconStop();
    $('recLabel').textContent='Recording… click to stop';
    $('recClock').classList.add('show');
    $('waveCanvas').classList.add('show');
    drawWave();

    recTick=setInterval(()=>{
      recElapsed++;
      $('recClock').textContent=fmtTime(recElapsed);
      if(recElapsed>=CFG.MAX_REC_SEC) stopRec();
    },1000);

  }catch(e){
    toast('Microphone access denied','err');
  }
}

function stopRec(){
  if(mediaRec&&mediaRec.state!=='inactive') mediaRec.stop();
  clearInterval(recTick);
  cancelAnimationFrame(rafId);
  try{ if(audioCtx) audioCtx.close(); }catch(e){}
  isRec=false;
  $('micBtn').classList.remove('rec-active');
  $('micBtn').innerHTML=iconMic();
  $('recClock').classList.remove('show');
  $('waveCanvas').classList.remove('show');
  $('recLabel').textContent='Processing…';
}

async function uploadRec(){
  if(!fbReady){ toast('Firebase not connected','err'); $('recLabel').textContent='Press to record'; return; }
  if(!recChunks.length){ toast('No audio recorded','err'); $('recLabel').textContent='Press to record a message for Hanna'; return; }

  $('recLabel').textContent='Saving…';
  $('uploadWrap').classList.add('show');
  $('uploadBar').style.width='30%';

  try{
    const mime = bestMime()||'audio/webm';
    const blob = new Blob(recChunks,{type:mime});

    // Convert to base64 — stored directly in Firestore, no Storage needed
    const base64 = await new Promise((res,rej)=>{
      const reader = new FileReader();
      reader.onloadend = ()=> res(reader.result); // full data URL
      reader.onerror  = ()=> rej(new Error('FileReader failed'));
      reader.readAsDataURL(blob);
    });

    $('uploadBar').style.width='65%';

    const now = new Date();

    // Count existing to number message
    const snap = await db.collection(CFG.COLLECTION).get();
    const num  = snap.size + 1;

    $('uploadBar').style.width='85%';

    await db.collection(CFG.COLLECTION).add({
      label:   `Message ${num} for Hanna`,
      dateStr: `${now.toLocaleDateString('en-GB')} · ${now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`,
      ts:      firebase.firestore.Timestamp.fromDate(now),
      dataUrl: base64,   // audio stored as base64 data URL
      mime:    mime,
    });

    $('uploadBar').style.width='100%';
    setTimeout(()=>{
      $('uploadWrap').classList.remove('show');
      $('uploadBar').style.width='0%';
    },400);

    $('recLabel').textContent='Saved ✦ Press to record again';
    setTimeout(()=>$('recLabel').textContent='Press to record a message for Hanna',3000);
    toast('Message saved for Hanna ✦','ok');
    loadMessages();

  }catch(e){
    console.error('Upload error:',e);
    $('uploadWrap').classList.remove('show');
    $('uploadBar').style.width='0%';
    $('recLabel').textContent='Failed — try again';
    toast('Save failed: '+e.message,'err');
  }
}

function drawWave(){
  const canvas=$('waveCanvas');
  const ctx=canvas.getContext('2d');
  function frame(){
    if(!analyser) return;
    rafId=requestAnimationFrame(frame);
    const buf=new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(buf);
    const W=canvas.width,H=canvas.height;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle='rgba(12,8,10,.5)';
    ctx.fillRect(0,0,W,H);
    const bw=W/buf.length;
    buf.forEach((v,i)=>{
      const h2=(v/255)*H;
      const g=ctx.createLinearGradient(0,H-h2,0,H);
      g.addColorStop(0,'#D4AF60');g.addColorStop(1,'#4A3010');
      ctx.fillStyle=g;
      ctx.fillRect(i*bw,H-h2,Math.max(1,bw-1),h2);
    });
  }
  frame();
}

function bestMime(){
  const types=['audio/webm;codecs=opus','audio/webm','audio/ogg;codecs=opus','audio/mp4'];
  for(const t of types){ if(typeof MediaRecorder!=='undefined'&&MediaRecorder.isTypeSupported(t)) return t; }
  return '';
}
function fmtTime(s){ return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }

/* ──────────────────────────────────────
   ADMIN (triple-click ⬡)
────────────────────────────────────── */
$('adm-hint').addEventListener('click',()=>{
  adminClicks++;
  clearTimeout(adminTimer);
  adminTimer=setTimeout(()=>adminClicks=0,700);
  if(adminClicks>=3){
    adminClicks=0;
    const pw=prompt('Admin code:');
    if(!pw) return;
    if(san(pw)===CFG.ADMIN_CODE){
      isAdmin=true;
      if(curPage==='p3') initVoicePage();
      toast('Admin mode enabled ✦','ok');
    } else {
      toast('Wrong admin code','err');
    }
  }
});

// Also check URL param
try{
  const sp=new URLSearchParams(location.search);
  if(sp.get('admin')===CFG.ADMIN_CODE){ isAdmin=true; }
}catch(e){}

/* ──────────────────────────────────────
   TOAST
────────────────────────────────────── */
let toastTimer=null;
function toast(msg,type){
  const t=$('toast');
  if(!t) return;
  t.textContent=san(msg);
  t.className=type+' show';
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

/* ──────────────────────────────────────
   ICONS
────────────────────────────────────── */
function iconMic(){ return `<svg viewBox="0 0 28 28" fill="none"><rect x="10" y="3" width="8" height="14" rx="4" fill="#F5EFE0" opacity=".9"/><path d="M6 14c0 4.4 3.6 8 8 8s8-3.6 8-8" stroke="#F5EFE0" stroke-width="2" stroke-linecap="round" fill="none" opacity=".9"/><line x1="14" y1="22" x2="14" y2="26" stroke="#F5EFE0" stroke-width="2" stroke-linecap="round" opacity=".9"/></svg>`; }
function iconStop(){ return `<svg viewBox="0 0 28 28" fill="none"><rect x="7" y="7" width="14" height="14" rx="2" fill="#F5EFE0"/></svg>`; }
function iconPlay(){ return `<svg viewBox="0 0 14 14"><polygon points="3,1 13,7 3,13" fill="#060404"/></svg>`; }
function iconPause(){ return `<svg viewBox="0 0 14 14"><rect x="2" y="1" width="4" height="12" fill="#060404"/><rect x="8" y="1" width="4" height="12" fill="#060404"/></svg>`; }

/* ──────────────────────────────────────
   UTILS
────────────────────────────────────── */
function $(id){ return document.getElementById(id); }
function svgEl(tag){ return document.createElementNS('http://www.w3.org/2000/svg',tag); }
function attrs(el,map){ for(const[k,v] of Object.entries(map)) el.setAttribute(k,v); }

window.addEventListener('resize',()=>{ if(curPage==='p2') buildRotary(); });

/* ──────────────────────────────────────
   BOOT
────────────────────────────────────── */
window.addEventListener('DOMContentLoaded',()=>{
  initFirebase();
  startAssembly();
  setTimeout(()=>$('loader').classList.add('hide'),600);
  goTo('p1');
});
</script>

<!--
╔══════════════════════════════════════════════════════════════════════╗
║          FIREBASE SETUP GUIDE — READ BEFORE UPLOADING TO GITHUB     ║
╠══════════════════════════════════════════════════════════════════════╣
║                                                                      ║
║  STEP 1 — Create a Firebase project                                  ║
║    → Go to: https://console.firebase.google.com                      ║
║    → Click "Add project" → name it "forhanna" → Create              ║
║                                                                      ║
║  STEP 2 — Register a Web App                                         ║
║    → In your project, click the </> (Web) icon                       ║
║    → Give it a nickname (e.g. "forhanna-web") → Register            ║
║    → Copy the firebaseConfig object values                           ║
║    → Paste them into FIREBASE_CONFIG at the top of this file        ║
║                                                                      ║
║  STEP 3 — Enable Firestore                                           ║
║    → Left sidebar → Build → Firestore Database → Create database    ║
║    → Start in TEST MODE                                              ║
║    → Set these Firestore Rules:                                      ║
║      rules_version = '2';                                            ║
║      service cloud.firestore {                                       ║
║        match /databases/{db}/documents {                             ║
║          match /{document=**} {                                      ║
║            allow read, write: if true;                               ║
║          }                                                           ║
║        }                                                             ║
║      }                                                               ║
║                                                                      ║
║  NOTE: No Firebase Storage needed! Audio is stored directly in       ║
║  Firestore as base64 — simpler and always works.                    ║
║  STEP 5 — For YOUR recording access (admin upload)                   ║
║    → Add your GitHub Pages domain to Firebase Authorized Domains:    ║
║    → Authentication → Settings → Authorized domains → Add domain    ║
║    → Add: yourusername.github.io                                     ║
║    → Then open: https://yourusername.github.io/forhanna/?admin=hanna2025
║                                                                      ║
║  STEP 6 — Deploy to GitHub Pages                                     ║
║    → Create a repo named "forhanna" (or any name)                   ║
║    → Upload this HTML file as index.html                             ║
║    → Settings → Pages → Source: Deploy from branch → main           ║
║    → Your site: https://yourusername.github.io/forhanna/            ║
║                                                                      ║
║  PASSWORD: 8825                                                      ║
║  ADMIN CODE: hanna2025  (used in URL or triple-click ⬡)             ║
╚══════════════════════════════════════════════════════════════════════╝
-->
</body>
</html>
